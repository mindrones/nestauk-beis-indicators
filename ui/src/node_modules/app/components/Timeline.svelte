<script>
	import { getContext } from 'svelte';
	import * as _ from 'lamb';

	import {goto} from '@sapper/app'; // dev, don't remove

	import {yearRange} from 'app/data/groups';
	import groups from 'app/data/indicatorsGroups.json';
	import {shortenYear} from 'app/utils';

	const {timelineLayoutStore} = getContext('layout');

	export let height;
	export let width;
	export let availableYears;
	export let selectedYear;
	export let indicatorId;

	$: layout = $timelineLayoutStore;
	$: yearsY = availableYears.length > 0 ? layout.y2 : layout.ym;

	/* buttons */

	$: buttonSize = layout.height / 2;
	$: buttonY = layout.height / 4;
	$: chevronLeftPath = `${buttonSize * 2/3} ${buttonSize/3} ${buttonSize/3} ${buttonSize/2} ${buttonSize * 2/3} ${buttonSize * 2/3}`;
	$: chevronRightPath = `${buttonSize/3} ${buttonSize/3} ${buttonSize * 2/3} ${buttonSize/2} ${buttonSize/3} ${buttonSize * 2/3}`;
	$: isNextActive = selectedYear && selectedYear !== _.last(availableYears);
	$: isPrevActive = selectedYear && selectedYear !== availableYears[0];
	$: clickedPrev = (indicatorId, year) => () => goto(`indicators/${indicatorId}/${year - 1}`);
	$: clickedNext = (indicatorId, year) => () => goto(`indicators/${indicatorId}/${year + 1}`);
</script>

<div
	class="Timeline"
	bind:clientHeight={height}
	bind:clientWidth={width}
>
	{#if width && layout}
	<svg
		{width}
		{height}
	>
		<!-- buttons -->
		{#if selectedYear}

			<!-- prev -->
			<g
				transform='translate({buttonY},{buttonY})'
				class:active={isPrevActive}
			>
				<rect
					height={buttonSize}
					width={buttonSize}
					on:click={isPrevActive && clickedPrev(indicatorId, selectedYear)}
				/>
				<polyline points={chevronLeftPath} />
			</g>

			<!-- next -->
			<g
				transform='translate({1.25 * buttonY + buttonSize},{buttonY})'
				class:active={isNextActive}
			>
				<rect
					height={buttonSize}
					width={buttonSize}
					on:click={isNextActive && clickedNext(indicatorId, selectedYear)}
				/>
				<polyline points={chevronRightPath} />
			</g>
		{/if}

		<!-- dots -->
		{#if availableYears}
		<g transform='translate(0,{layout.y1})'>
			<line
				x1='{layout.scaleX(availableYears[0]) + layout.radius}'
				x2='{layout.scaleX(_.last(availableYears)) - layout.radius}'
			/>
			{#each availableYears as year}
			<circle
				class:selected='{selectedYear && selectedYear === year}'
				cx='{layout.scaleX(year)}'
				r={layout.radius}
				on:click='{() => goto(`indicators/${indicatorId}/${year}`)}'
			/>
			{/each}
		</g>
		{/if}

		<!-- labels -->
		{#each yearRange as year}
		<text
			font-size={layout.fontSize}
			x={layout.scaleX(year)}
			y={yearsY}
		>{layout.doShortenYears ? shortenYear(year): year}</text>
		{/each}
	</svg>
	{/if}
</div>

<style>
	.Timeline {
		height: 100%;
		width: 100%;
		user-select: none;
	}

	svg text {
		stroke: none;
		fill: var(--color-grey-70);
		dominant-baseline: middle;
		text-anchor: middle;
		pointer-events: none;
	}

	svg line {
		stroke: var(--color-grey-70);
		stroke-width: 0.75;
		pointer-events: none;
	}

	svg circle {
		fill-opacity: 1;
		fill: white;
		stroke: var(--color-grey-70);
		stroke-width: 1.5;
		cursor: pointer;
	}
	svg circle.selected {
		fill: var(--color-main-desat-50);
	}

	/* buttons */

	rect {
		fill: white;
	}
	polyline {
		fill: none;
		stroke-width: 2;
		pointer-events: none;
	}

	rect, polyline {
		stroke: var(--color-grey-180);
	}
	.active {
		cursor: pointer;
	}
	.active rect,
	.active polyline {
		stroke: var(--color-grey-70);
	}
</style>
